<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport"
 content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>99ä¹˜æ³•è€ƒè©¦</title>

<style>
html,body{
 margin:0;padding:0;
 font-family:"Arial Rounded MT Bold","Arial",sans-serif;
 background:linear-gradient(#e3f2fd,#ffffff);
 touch-action:manipulation;
 user-select:none;
}
.container{
 max-width:420px;
 margin:auto;
 padding:20px;
 text-align:center;
}
h1{color:#1976d2;}
#status{font-size:20px;color:#555;}
#timer{font-size:24px;color:#e53935;font-weight:bold;}
#question{
 font-size:34px;
 background:#fff9c4;
 padding:15px;
 border-radius:20px;
 margin:15px 0;
}
#reveal{
 display:none;
 font-size:32px;
 color:red;
 font-weight:bold;
 margin:10px 0;
}
#input{
 width:100%;
 height:55px;
 font-size:30px;
 text-align:center;
 border-radius:15px;
 border:3px solid #90caf9;
 background:#e3f2fd;
}
.keypad{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:12px;
 margin-top:15px;
}
.keypad button{
 font-size:26px;
 padding:20px;
 border-radius:20px;
 border:none;
 background:#64b5f6;
 color:white;
}
button.control{
 margin-top:18px;
 padding:12px 30px;
 font-size:22px;
 border-radius:20px;
 border:none;
 background:#f48fb1;
 color:white;
}

/* æˆç¸¾å½ˆçª— */
#overlay{
 display:none;
 position:fixed;
 top:0;left:0;right:0;bottom:0;
 background:rgba(0,0,0,0.4);
 z-index:10;
}
#resultBox{
 background:white;
 width:85%;
 max-width:360px;
 margin:120px auto;
 padding:20px;
 border-radius:20px;
 text-align:center;
}
#resultBox h2{font-size:26px;margin-top:0;}
#resultBox p{font-size:20px;}
#resultBox button{
 margin:10px;
 padding:10px 18px;
 font-size:18px;
 border:none;
 border-radius:15px;
 background:#64b5f6;
 color:white;
}
#wrongList{
 display:none;
 text-align:left;
 font-size:18px;
 margin-top:10px;
}
</style>
</head>

<body>
<div class="container">
<h1>99ä¹˜æ³•è€ƒè©¦</h1>

<div id="status">å°šæœªé–‹å§‹</div>
<div id="timer">æ™‚é–“ï¼š8</div>
<div id="question">è«‹æŒ‰é–‹å§‹</div>
<div id="reveal"></div>
<input id="input" readonly>

<div class="keypad">
<button>1</button><button>2</button><button>3</button>
<button>4</button><button>5</button><button>6</button>
<button>7</button><button>8</button><button>9</button>
<button>0</button><button>æ¸…é™¤</button>
</div>

<button class="control" id="startBtn">é–‹å§‹æ¸¬é©—</button>
</div>

<div id="overlay">
 <div id="resultBox">
  <h2>ğŸ“Š æˆç¸¾ç¸½çµ</h2>
  <p id="summaryText"></p>
  <button onclick="toggleWrong()">æŸ¥çœ‹éŒ¯èª¤çš„ä¹˜æ³•æ˜ç´°</button>
  <button onclick="closeResult()">é—œé–‰</button>
  <div id="wrongList"></div>
 </div>
</div>

<script>
/* ===== èªéŸ³ ===== */
function speak(t){
 speechSynthesis.cancel();
 const u=new SpeechSynthesisUtterance(t);
 u.lang="zh-TW";
 u.rate=0.9;
 speechSynthesis.speak(u);
}

/* ===== iOS éŸ³æ•ˆè§£é– ===== */
let audioCtx;
function unlockAudio(){
 if(!audioCtx){
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
 }
 if(audioCtx.state==="suspended") audioCtx.resume();
}
function unlockIOSAudio(){
 unlockAudio();
 const o=audioCtx.createOscillator();
 const g=audioCtx.createGain();
 g.gain.value=0;
 o.connect(g).connect(audioCtx.destination);
 o.start();
 o.stop(audioCtx.currentTime+0.02);
}
function ding(){
 unlockAudio();
 const now=audioCtx.currentTime;
 for(let i=0;i<2;i++){
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=800+i*300;
  g.gain.value=0.15;
  o.connect(g).connect(audioCtx.destination);
  o.start(now+i*0.15);
  o.stop(now+i*0.15+0.12);
 }
}
function tickSound(urgent=false){
 unlockAudio();
 const o=audioCtx.createOscillator();
 const g=audioCtx.createGain();
 o.frequency.value=urgent?1200:600;
 g.gain.value=urgent?0.08:0.04;
 o.connect(g).connect(audioCtx.destination);
 o.start();
 o.stop(audioCtx.currentTime+0.05);
}

/* ===== éŠæˆ² ===== */
const TOTAL=30, LIMIT=8;
let q=0,a=0,b=0,ans=0,time=0,timer;
let playing=false;
let correct=0;
let correctTimes=[];
let wrongRecords=[];
let questionStart=0;

const startBtn=document.getElementById("startBtn");
const reveal=document.getElementById("reveal");

startBtn.onclick=()=>{
 if(playing) return;
 unlockIOSAudio();
 start();
};

function start(){
 q=0; correct=0; correctTimes=[]; wrongRecords=[];
 playing=true;
 startBtn.disabled=true;
 startBtn.textContent="æ¸¬é©—ä¸­";
 next();
}

function next(){
 clearInterval(timer);
 reveal.style.display="none";

 if(q>=TOTAL){
  end();
  return;
 }

 q++;
 time=LIMIT;
 document.getElementById("status").textContent=`ç¬¬ ${q} / ${TOTAL} é¡Œ`;
 document.getElementById("timer").textContent=`æ™‚é–“ï¼š${time}`;
 document.getElementById("input").value="";

 a=Math.floor(Math.random()*9)+1;
 b=Math.floor(Math.random()*9)+1;
 ans=a*b;
 document.getElementById("question").textContent=`${a} Ã— ${b} = ?`;
 questionStart=Date.now();

 timer=setInterval(()=>{
  time--;
  document.getElementById("timer").textContent=`æ™‚é–“ï¼š${time}`;
  if(time>0) tickSound(time<=3);
  if(time<=0) recordWrong();
 },1000);
}

document.querySelectorAll(".keypad button").forEach(btn=>{
 btn.onclick=()=>{
  if(!playing) return;
  unlockAudio();
  if(btn.textContent==="æ¸…é™¤"){
   document.getElementById("input").value="";
   return;
  }
  press(btn.textContent);
 };
});

function press(n){
 const input=document.getElementById("input");
 input.value+=n;

 if(+input.value===ans){
  ding();
  correct++;
  correctTimes.push((Date.now()-questionStart)/1000);
  next();
 }else if(input.value.length>=ans.toString().length){
  recordWrong();
 }
}

function recordWrong(){
 clearInterval(timer);
 speak("ç­”éŒ¯äº†");

 wrongRecords.push(`${a} Ã— ${b} = ${ans}`);

 reveal.textContent=`æ­£ç¢ºç­”æ¡ˆï¼š${a} Ã— ${b} = ${ans}`;
 reveal.style.display="block";

 setTimeout(next,3200); // â­ éŒ¯èª¤é¡¯ç¤º 3.2 ç§’
}

function end(){
 playing=false;
 startBtn.disabled=false;
 startBtn.textContent="é‡æ–°æ¸¬é©—";
 speak("æ­å–œä½ å®Œæˆæ¸¬é©—");

 const avg = correctTimes.length
  ? (correctTimes.reduce((a,b)=>a+b,0)/correctTimes.length).toFixed(1)
  : 0;

 document.getElementById("summaryText").innerHTML=
  `âœ” ç­”å°ï¼š${correct} / ${TOTAL}<br>`+
  `â± å¹³å‡ç­”å°æ™‚é–“ï¼š${avg} ç§’`;

 document.getElementById("wrongList").style.display="none";
 document.getElementById("wrongList").innerHTML=
  wrongRecords.length
   ? wrongRecords.map(r=>`âŒ ${r}`).join("<br>")
   : "ğŸ‰ æ²’æœ‰éŒ¯èª¤";

 document.getElementById("overlay").style.display="block";
}

function toggleWrong(){
 const w=document.getElementById("wrongList");
 w.style.display = w.style.display==="none" ? "block" : "none";
}
function closeResult(){
 document.getElementById("overlay").style.display="none";
}
</script>
</body>
</html>
