<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>99ä¹˜æ³•æ¸¬é©—</title>

<style>
body{
  margin:0;
  font-family:"Noto Sans TC",system-ui;
  background:#fff3e0;
  text-align:center;
}
h1{color:#ff7043}

.card{
  background:#fff;
  margin:16px;
  padding:16px;
  border-radius:24px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}

#question{font-size:34px}
#timer{font-size:22px;color:#d84315}

#answerBox{
  border:4px solid #ffccbc;
  border-radius:16px;
  font-size:34px;
  padding:10px;
  width:160px;
  margin:12px auto 6px;
  min-height:42px;
  color:#1890ff;
}

#correctHint{
  font-size:20px;
  color:#d32f2f;
  min-height:26px;
}

.keypad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  max-width:260px;
  margin:12px auto;
}
.keypad button{
  font-size:26px;
  padding:14px;
  border:none;
  border-radius:16px;
  background:#ffab91;
}

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  justify-content:center;
  align-items:center;
}

.resultCard{
  background:#fffdf7;
  border-radius:26px;
  padding:20px;
  width:90%;
  max-width:360px;
}

.resultHeader{
  font-size:32px;
  color:#ff6f61;
  margin-bottom:10px;
}

.scoreRow{
  display:flex;
  justify-content:space-between;
  font-size:22px;
  margin:6px 0;
}

.resultBtn{
  width:100%;
  margin-top:10px;
  font-size:20px;
  padding:10px;
  border:none;
  border-radius:16px;
}

.retry{background:#52c41a;color:white}
.restart{background:#1890ff;color:white}

.detail{
  background:#fff1f0;
  border-radius:14px;
  padding:10px;
  margin-top:10px;
  text-align:left;
  display:none;
}
.detailItem{
  font-size:20px;
  margin-bottom:6px;
}

/* ğŸ˜­ å“­è‡‰å‹•ç•« */
#cryFace{
  position:fixed;
  left:50%;
  top:40%;
  transform:translate(-50%,-50%);
  font-size:80px;
  opacity:0;
  pointer-events:none;
  z-index:9999;
}
@keyframes cryAnim{
  0%{opacity:0;transform:translate(-50%,-50%) scale(.4)}
  20%{opacity:1;transform:translate(-50%,-50%) scale(1.1) rotate(-10deg)}
  60%{transform:translate(-50%,-50%) rotate(10deg)}
  100%{opacity:0;transform:translate(-50%,-50%) scale(.6)}
}
.showCry{animation:cryAnim 1.2s}

/* â­ æ˜Ÿæ˜Ÿçˆ†é–‹ */
#starBurst{
  position:fixed;
  left:50%;
  top:45%;
  transform:translate(-50%,-50%);
  pointer-events:none;
  z-index:9999;
}
.star{
  position:absolute;
  font-size:28px;
  animation:starFly 1.2s ease-out forwards;
}
@keyframes starFly{
  0%{opacity:0;transform:translate(0,0) scale(.4)}
  20%{opacity:1}
  100%{
    opacity:0;
    transform:translate(var(--x),var(--y)) scale(1.2) rotate(360deg);
  }
}
</style>
</head>

<body>
<h1>99ä¹˜æ³•æ¸¬é©—</h1>

<div class="card" id="startCard">
  <button class="resultBtn restart" id="startBtn">â–¶ é–‹å§‹æ¸¬é©—</button>
</div>

<div class="card" id="quizCard" style="display:none">
  <div id="progress"></div>
  <div id="question"></div>
  <div id="timer"></div>
  <div id="answerBox"></div>
  <div id="correctHint"></div>
  <div class="keypad" id="pad"></div>
</div>

<div class="overlay" id="resultOverlay">
  <div class="resultCard" id="resultCard"></div>
</div>

<div id="cryFace">ğŸ˜­</div>
<div id="starBurst"></div>

<script>
/* éŸ³æ•ˆ */
let audioCtx;
function initAudio(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    audioCtx.resume();
  }
}
function beep(f=800,t=.05){
  if(!audioCtx)return;
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=f; g.gain.value=.12;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+t);
  o.stop(audioCtx.currentTime+t);
}
function ding(){beep(1200,.08);setTimeout(()=>beep(1500,.08),120)}
function speak(t){
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(t);
  u.lang="zh-TW";
  speechSynthesis.speak(u);
}

/* æ˜Ÿæ˜Ÿ */
function showStars(){
  const box=document.getElementById("starBurst");
  box.innerHTML="";
  ["â­","âœ¨","ğŸŒŸ"].forEach((ch,i)=>{
    for(let j=0;j<5;j++){
      const s=document.createElement("div");
      s.className="star";
      s.textContent=ch;
      s.style.setProperty("--x",`${Math.random()*300-150}px`);
      s.style.setProperty("--y",`${Math.random()*300-150}px`);
      box.appendChild(s);
    }
  });
  setTimeout(()=>box.innerHTML="",1400);
}

/* å“­è‡‰ */
function showCry(){
  const c=document.getElementById("cryFace");
  c.classList.remove("showCry");
  void c.offsetWidth;
  c.classList.add("showCry");
}

/* ç‹€æ…‹ */
let list=[],i=0,ans="",sec=8,timer;
let wrong=[],correct=0;

/* DOM */
const startBtn=document.getElementById("startBtn");
const startCard=document.getElementById("startCard");
const quizCard=document.getElementById("quizCard");
const qEl=document.getElementById("question");
const tEl=document.getElementById("timer");
const aEl=document.getElementById("answerBox");
const hint=document.getElementById("correctHint");
const pad=document.getElementById("pad");
const overlay=document.getElementById("resultOverlay");
const resultCard=document.getElementById("resultCard");

/* éµç›¤ */
["1","2","3","4","5","6","7","8","9","del","0"].forEach(k=>{
  const b=document.createElement("button");
  b.textContent=k==="del"?"âŒ«":k;
  b.onclick=()=>k==="del"?del():press(k);
  pad.appendChild(b);
});

/* é–‹å§‹ */
startBtn.onclick=()=>{
  initAudio();beep(200,.05);
  list=Array.from({length:20},()=>({
    a:1+Math.floor(Math.random()*9),
    b:1+Math.floor(Math.random()*9)
  }));
  i=0;correct=0;wrong=[];
  startCard.style.display="none";
  quizCard.style.display="block";
  next();
};

function next(){
  clearInterval(timer);
  ans="";aEl.textContent="";hint.textContent="";
  if(i>=list.length)return finish();
  const q=list[i];
  qEl.textContent=`${q.a} Ã— ${q.b} = ?`;
  sec=8;tEl.textContent=`â± ${sec}`;
  timer=setInterval(()=>{
    sec--;beep(700);
    tEl.textContent=`â± ${sec}`;
    if(sec<=0)mark(false);
  },1000);
}

function press(d){
  if(ans.length>=2)return;
  ans+=d;aEl.textContent=ans;
  const q=list[i],c=q.a*q.b;
  if((c<10&&ans.length===1)||(c>=10&&ans.length===2))
    mark(Number(ans)===c);
}
function del(){
  ans=ans.slice(0,-1);
  aEl.textContent=ans;
}

function mark(ok){
  clearInterval(timer);
  const q=list[i],c=q.a*q.b;
  if(ok){
    correct++;ding();i++;setTimeout(next,300);
  }else{
    showCry();
    wrong.push(`${q.a} Ã— ${q.b} = ${c}ï¼ˆä½ çš„ç­”æ¡ˆï¼š${ans||"æœªè¼¸å…¥"}ï¼‰`);
    hint.textContent=`æ­£ç¢ºç­”æ¡ˆï¼š${c}`;
    speak("ç­”éŒ¯äº†");
    i++;setTimeout(next,2000);
  }
}

function finish(){
  speak("æ­å–œä½ å®Œæˆæ¸¬é©—");
  quizCard.style.display="none";
  let html=wrong.map(w=>`<div class="detailItem">${w}</div>`).join("");
  resultCard.innerHTML=`
    <div class="resultHeader">ğŸ“˜ æˆç¸¾å–®</div>
    <div class="scoreRow"><span>ç­”å°</span><span>${correct}</span></div>
    <div class="scoreRow"><span>ç­”éŒ¯</span><span>${wrong.length}</span></div>
    <button class="resultBtn retry" onclick="retry()">éŒ¯é¡Œé‡ç·´</button>
    <button class="resultBtn restart" onclick="location.reload()">é‡æ–°æ¸¬é©—</button>
    <button class="resultBtn" onclick="toggle()">æŸ¥çœ‹éŒ¯èª¤æ˜ç´°</button>
    <div class="detail" id="detail">${html||"ğŸ‰ å…¨å°ï¼"}</div>
  `;
  overlay.style.display="flex";
  showStars();
}
function toggle(){
  const d=document.getElementById("detail");
  d.style.display=d.style.display==="none"?"block":"none";
}
function retry(){
  list=wrong.map(w=>{
    const m=w.match(/(\d+)\sÃ—\s(\d+)/);
    return {a:+m[1],b:+m[2]};
  });
  i=0;wrong=[];correct=0;
  overlay.style.display="none";
  quizCard.style.display="block";
  next();
}
</script>
</body>
</html>
