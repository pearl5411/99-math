<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>99乘法考試</title>

<style>
body{
 font-family:"Noto Sans TC",system-ui;
 background:#fff7e6;
 text-align:center;
 margin:0;
 padding:10px;
}
h1{color:#ff7a00;}
#card{
 background:white;
 border-radius:16px;
 padding:16px;
 box-shadow:0 4px 10px rgba(0,0,0,.15);
 max-width:420px;
 margin:auto;
}
#question{
 font-size:36px;
 margin:20px 0;
}
#timer{
 font-size:20px;
 color:#ff4d4f;
}
#progress{
 font-size:18px;
 margin-top:10px;
}
#reveal{
 font-size:28px;
 color:red;
 display:none;
 margin-top:10px;
}
#pad{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:10px;
 margin-top:15px;
}
button{
 font-size:24px;
 padding:14px;
 border-radius:12px;
 border:none;
 background:#ffd591;
}
button:active{background:#ffb84d;}
#startBtn{
 background:#52c41a;
 color:white;
 margin-top:10px;
}
#resultBox{
 display:none;
 background:white;
 border-radius:16px;
 padding:20px;
 margin-top:20px;
}
.big{
 font-size:26px;
 font-weight:bold;
}
</style>
</head>

<body>
<h1>99 乘法考試</h1>

<div id="card">
 <div id="progress"></div>
 <div id="timer"></div>
 <div id="question">請按開始</div>
 <div id="reveal"></div>

 <div id="pad"></div>

 <button id="startBtn">開始測驗</button>
</div>

<div id="resultBox"></div>

<!-- 音效（base64，iOS 穩定） -->
<audio id="beep" src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="></audio>
<audio id="ding" src="data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YYAAAAA="></audio>

<script>
/* ===== 狀態 ===== */
let questions=[],index=0;
let a,b,answer;
let sec=8,timerId=null;
let answered=false;
let token=0;
let correct=0,wrong=0;
let totalCorrectTime=0;
let startTime=0;
let running=false;

/* ===== DOM ===== */
const qEl = document.getElementById("question");
const tEl = document.getElementById("timer");
const pEl = document.getElementById("progress");
const rEl = document.getElementById("reveal");
const pad = document.getElementById("pad");
const resultBox = document.getElementById("resultBox");

/* ===== 建立鍵盤 ===== */
for(let i=1;i<=9;i++){
 let b=document.createElement("button");
 b.textContent=i;
 b.onclick=()=>submit(i);
 pad.appendChild(b);
}

/* ===== 音效 ===== */
function play(id){
 const a=document.getElementById(id);
 a.currentTime=0;
 a.play().catch(()=>{});
}
function speak(text){
 speechSynthesis.cancel();
 speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}

/* ===== 開始 ===== */
document.getElementById("startBtn").onclick=()=>{
 if(running) return;
 running=true;
 questions=[];
 for(let i=0;i<30;i++){
  questions.push({
   a:Math.floor(Math.random()*9)+1,
   b:Math.floor(Math.random()*9)+1
  });
 }
 index=0;correct=0;wrong=0;totalCorrectTime=0;
 resultBox.style.display="none";
 next();
};

/* ===== 下一題 ===== */
function next(){
 clearInterval(timerId);
 answered=false;
 token++;
 rEl.style.display="none";

 if(index>=questions.length){
  finish();
  return;
 }

 const q=questions[index];
 a=q.a;b=q.b;answer=a*b;
 startTime=Date.now();

 pEl.textContent=`第 ${index+1} / 30 題`;
 qEl.textContent=`${a} × ${b} = ?`;

 startTimer(token);
}

/* ===== 計時 ===== */
function startTimer(myToken){
 sec=8;
 tEl.textContent=`剩餘 ${sec} 秒`;
 timerId=setInterval(()=>{
  if(myToken!==token) return;
  sec--;
  play("beep");
  tEl.textContent=`剩餘 ${sec} 秒`;
  if(sec<=0){
   clearInterval(timerId);
   if(answered) return;
   answered=true;
   wrong++;
   rEl.textContent=`${a} × ${b} = ${answer}`;
   rEl.style.display="block";
   speak("答錯了");
   setTimeout(()=>{index++;next();},2000);
  }
 },1000);
}

/* ===== 作答 ===== */
function submit(n){
 if(answered||!running) return;
 if(n===answer){
  answered=true;
  clearInterval(timerId);
  correct++;
  totalCorrectTime+=(Date.now()-startTime)/1000;
  play("ding");play("ding");
  index++;
  next();
 }else{
  answered=true;
  clearInterval(timerId);
  wrong++;
  rEl.textContent=`${a} × ${b} = ${answer}`;
  rEl.style.display="block";
  speak("答錯了");
  setTimeout(()=>{index++;next();},2000);
 }
}

/* ===== 結束 ===== */
function finish(){
 running=false;
 speak("恭喜你完成測驗");
 const avg = correct? (totalCorrectTime/correct).toFixed(1):0;
 resultBox.innerHTML=`
  <div class="big">測驗完成</div><br>
  ✔ 答對：${correct} 題<br>
  ✖ 答錯：${wrong} 題<br>
  ⏱ 平均答對時間：${avg} 秒<br><br>
  <button onclick="location.reload()">重新測驗</button>
 `;
 resultBox.style.display="block";
}
</script>
</body>
</html>
