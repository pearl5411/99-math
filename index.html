<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>99乘法考試</title>

<style>
body{
 font-family:"Noto Sans TC",system-ui;
 background:#fff7e6;
 text-align:center;
 margin:0;padding:10px;
}
h1{color:#ff7a00;}
#card{
 background:#fff;
 border-radius:16px;
 padding:16px;
 max-width:420px;
 margin:auto;
 box-shadow:0 4px 10px rgba(0,0,0,.15);
}
#question{font-size:36px;margin:10px 0;}
#input{font-size:32px;color:#1890ff;height:40px;}
#timer{color:#ff4d4f;font-size:20px;}
#progress{font-size:18px;}
#reveal{font-size:28px;color:red;display:none;}
#pad{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:10px;margin-top:10px;
}
button{
 font-size:24px;padding:14px;
 border:none;border-radius:12px;
 background:#ffd591;
}
button:active{background:#ffb84d;}
#startBtn{background:#52c41a;color:#fff;margin-top:10px;}
#resultBox{
 display:none;background:#fff;
 border-radius:16px;padding:20px;margin-top:20px;
}
.big{font-size:26px;font-weight:bold;}
.detail{color:#ff4d4f;margin-top:6px;}
</style>
</head>

<body>
<h1>99乘法考試</h1>

<div id="card">
 <div id="progress"></div>
 <div id="timer"></div>
 <div id="question">請按開始</div>
 <div id="input"></div>
 <div id="reveal"></div>
 <div id="pad"></div>
 <button id="startBtn">開始測驗</button>
</div>

<div id="resultBox"></div>

<audio id="beep" src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="></audio>
<audio id="ding" src="data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YYAAAAA="></audio>

<script>
/* ===== DOM ===== */
const qEl = document.getElementById("question");
const tEl = document.getElementById("timer");
const pEl = document.getElementById("progress");
const rEl = document.getElementById("reveal");
const inputEl = document.getElementById("input");
const padEl = document.getElementById("pad");
const resultBox = document.getElementById("resultBox");
const startBtn = document.getElementById("startBtn");

/* ===== 狀態 ===== */
let questions=[], wrongList=[];
let index=0, a=0, b=0, answer=0;
let sec=8, timerId=null;
let answered=false, running=false;
let token=0, inputBuffer="";
let correct=0, wrong=0;
let totalCorrectTime=0, startTime=0;
let audioUnlocked=false;

/* ===== 建立數字鍵 ===== */
for(let i=1;i<=9;i++){
 const btn=document.createElement("button");
 btn.textContent=i;
 btn.onclick=()=>submit(i);
 padEl.appendChild(btn);
}

/* ===== 音效（安全播放） ===== */
function safePlay(id){
 if(!audioUnlocked) return;
 const a=document.getElementById(id);
 a.currentTime=0;
 a.play().catch(()=>{});
}
function speak(text){
 if(!audioUnlocked) return;
 speechSynthesis.cancel();
 speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}

/* ===== 解鎖音效（iPhone 必須） ===== */
function unlockAudio(){
 if(audioUnlocked) return;
 audioUnlocked=true;
 document.getElementById("beep").play().catch(()=>{});
 document.getElementById("ding").play().catch(()=>{});
}

/* ===== 開始測驗 ===== */
startBtn.onclick=()=>{
 unlockAudio();
 if(running) return;

 running=true;
 questions=[]; wrongList=[];
 correct=wrong=totalCorrectTime=0;
 index=0;

 for(let i=0;i<30;i++){
  questions.push({
   a:Math.floor(Math.random()*9)+1,
   b:Math.floor(Math.random()*9)+1
  });
 }

 resultBox.style.display="none";
 next();
};

/* ===== 下一題 ===== */
function next(){
 clearInterval(timerId);
 answered=false;
 inputBuffer="";
 inputEl.textContent="";
 rEl.style.display="none";
 token++;

 if(index>=questions.length){
  finish();
  return;
 }

 ({a,b}=questions[index]);
 answer=a*b;
 startTime=Date.now();

 pEl.textContent=`第 ${index+1} / ${questions.length} 題`;
 qEl.textContent=`${a} × ${b} = ?`;

 startTimer(token);
}

/* ===== 計時 ===== */
function startTimer(myToken){
 sec=8;
 tEl.textContent=`剩 ${sec} 秒`;
 timerId=setInterval(()=>{
  if(myToken!==token) return;
  sec--;
  safePlay("beep");
  tEl.textContent=`剩 ${sec} 秒`;

  if(sec<=0){
   clearInterval(timerId);
   if(answered) return;
   answered=true;
   wrong++;
   wrongList.push({a,b,answer,user:null});
   rEl.textContent=`${a} × ${b} = ${answer}`;
   rEl.style.display="block";
   speak("答錯了");
   setTimeout(()=>{index++;next();},2000);
  }
 },1000);
}

/* ===== 作答 ===== */
function submit(n){
 if(answered||!running) return;

 inputBuffer+=n;
 inputEl.textContent=inputBuffer;

 if(inputBuffer.length < String(answer).length) return;

 answered=true;
 clearInterval(timerId);

 if(Number(inputBuffer)===answer){
  correct++;
  totalCorrectTime+=(Date.now()-startTime)/1000;
  safePlay("ding"); safePlay("ding");
 }else{
  wrong++;
  wrongList.push({a,b,answer,user:Number(inputBuffer)});
  rEl.textContent=`${a} × ${b} = ${answer}`;
  rEl.style.display="block";
  speak("答錯了");
 }

 setTimeout(()=>{index++;next();},2000);
}

/* ===== 結束 ===== */
function finish(){
 running=false;
 speak("恭喜你完成測驗");
 const avg=correct?(totalCorrectTime/correct).toFixed(1):0;

 let detail="";
 wrongList.forEach(q=>{
  detail+=`<div class="detail">${q.a}×${q.b}＝${q.answer}（你答：${q.user??"未答"}）</div>`;
 });

 resultBox.innerHTML=`
 <div class="big">測驗完成</div><br>
 ✔ 答對：${correct} 題<br>
 ✖ 答錯：${wrong} 題<br>
 ⏱ 平均答對時間：${avg} 秒<br><br>
 <button onclick="location.reload()">重新測驗</button>
 <button onclick="retryWrong()">錯題重練</button>
 <div>${detail}</div>
 `;
 resultBox.style.display="block";
}

function retryWrong(){
 if(wrongList.length===0) return;
 questions = wrongList.map(q=>({a:q.a,b:q.b}));
 wrongList=[];
 index=0;
 correct=wrong=totalCorrectTime=0;
 resultBox.style.display="none";
 running=true;
 next();
}
</script>
</body>
</html>
