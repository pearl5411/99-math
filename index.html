<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>99ä¹˜æ³•è€ƒè©¦ - ä¿®æ­£ç‰ˆ</title>
<style>
body{margin:0;font-family:"Noto Sans TC",system-ui;background:#fff3e0;text-align:center}
h1{color:#ff7043;margin:12px 0}
.card{background:#fff;margin:16px;padding:16px;border-radius:22px;box-shadow:0 4px 12px rgba(0,0,0,.15)}
#question{font-size:34px;margin:10px 0}
#timer{font-size:22px;color:#d84315}
#answerBox{border:4px solid #ffccbc;border-radius:14px;font-size:32px;padding:10px;width:160px;margin:12px auto;background:#fff;min-height:40px;color:#1890ff}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:260px;margin:10px auto}
.keypad button{font-size:26px;padding:14px;border:none;border-radius:16px;background:#ffab91}
.keypad button:active{transform:scale(.95)}
.controlBtn{font-size:22px;padding:12px 26px;border:none;border-radius:18px;background:#ff7043;color:white}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;justify-content:center;align-items:center}
.resultCard{background:linear-gradient(180deg,#fffdf7,#fff4e6);border-radius:26px;padding:20px;width:90%;max-width:360px;position:relative}
.resultCard::before{content:"â­";position:absolute;top:-14px;left:-10px;font-size:36px}
.resultCard::after{content:"ğŸ€";position:absolute;top:-16px;right:-8px;font-size:34px}
.resultHeader{font-size:32px;color:#ff6f61;font-weight:bold}
.scoreRow{display:flex;justify-content:space-between;background:#fff;border-radius:14px;padding:8px 14px;margin:8px 0;font-size:20px}
.scoreRow span:last-child{font-size:24px;color:#fa541c}
.avgTime{font-size:18px;color:#9254de;margin:10px 0}
.resultBtn{width:100%;margin-top:10px;font-size:20px;padding:10px;border:none;border-radius:16px}
.retry{background:#52c41a;color:white}
.restart{background:#1890ff;color:white}
.wrongList{background:#fff1f0;border-radius:16px;padding:10px;margin-top:10px;max-height:160px;overflow:auto;text-align:left}
.wrongItem{color:#a8071a;margin-bottom:4px}
</style>
</head>
<body>
<h1>99ä¹˜æ³•è€ƒè©¦</h1>

<div class="card" id="startCard">
  <button class="controlBtn" id="startBtn">â–¶ é–‹å§‹æ¸¬é©—</button>
</div>

<div class="card" id="quizCard" style="display:none">
  <div id="progress"></div>
  <div id="question"></div>
  <div id="timer"></div>
  <div id="answerBox"></div>

  <div class="keypad" id="pad">
    <!-- æŒ‰éµç”± script å»ºç«‹ -->
  </div>
</div>

<div class="overlay" id="resultOverlay">
  <div class="resultCard" id="resultCard"></div>
</div>

<script>
/* ================= éŸ³æ•ˆï¼šWeb Audio APIï¼ˆç©©å®šï¼‰ ================= */
let audioCtx = null;
function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  // ç¢ºä¿ resumed on user gesture:
  audioCtx.resume().catch(()=>{});
}
function beep(freq=800, duration=0.06, gain=0.12){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.setValueAtTime(gain, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  o.stop(audioCtx.currentTime + duration + 0.02);
}
function ding(){
  beep(1200,0.09,0.18);
  setTimeout(()=>beep(1500,0.09,0.16),120);
}
function speak(text){
  // use speechSynthesis for "ç­”éŒ¯äº†" and end message
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'zh-TW';
    speechSynthesis.speak(u);
  }catch(e){}
}

/* ================= DOMï¼ˆæ˜ç¢ºæŠ“å–ï¼‰ ================= */
const startBtn = document.getElementById('startBtn');
const startCard = document.getElementById('startCard');
const quizCard = document.getElementById('quizCard');
const progressEl = document.getElementById('progress');
const questionEl = document.getElementById('question');
const timerEl = document.getElementById('timer');
const answerBox = document.getElementById('answerBox');
const pad = document.getElementById('pad');
const resultOverlay = document.getElementById('resultOverlay');
const resultCard = document.getElementById('resultCard');

/* ================= ç‹€æ…‹ ================= */
let q = [], idx = 0, ans = '', sec = 8, timerId = null;
let correct = 0, wrong = 0, correctTimes = [], wrongDetail = [];
let running = false;

/* ================= å»ºéµç›¤ï¼ˆå« 0 èˆ‡ åˆªé™¤ï¼‰ ================= */
const keys = ['1','2','3','4','5','6','7','8','9','del','0'];
keys.forEach(k=>{
  const btn = document.createElement('button');
  if(k==='del'){ btn.textContent='âŒ«'; btn.className=''; btn.onclick = ()=>{ if(!running) return; if(ans.length>0) { ans = ans.slice(0,-1); renderAnswer(); } }; }
  else { btn.textContent = k; btn.onclick = ()=>{ if(!running) return; press(k); }; }
  pad.appendChild(btn);
});
/* å³ä¸‹ç©ºä½ï¼ˆfor grid symmetryï¼‰ */
const spacer = document.createElement('button'); spacer.disabled=true; spacer.style.visibility='hidden'; pad.appendChild(spacer);

/* ================= é–‹å§‹æŒ‰éˆ•ï¼ˆè§£é–éŸ³è¨Šï¼‰ ================= */
startBtn.addEventListener('click', ()=>{
  initAudio();
  // ç°¡çŸ­è²éŸ¿ä½œç‚º unlock
  beep(100,0.01,0.02);
  if(running) return;
  start();
});

/* ================= æµç¨‹å‡½å¼ ================= */
function start(list){
  q = list || Array.from({length:30}, ()=>({a:1+Math.floor(Math.random()*9), b:1+Math.floor(Math.random()*9)}));
  idx = 0; ans=''; sec=8;
  correct = 0; wrong = 0; correctTimes=[]; wrongDetail=[];
  running = true;
  startCard.style.display = 'none';
  quizCard.style.display = 'block';
  next();
}

function next(){
  clearInterval(timerId);
  ans = '';
  renderAnswer();
  timerEl.textContent = '';
  if(idx >= q.length){ finish(); return; }
  const {a,b} = q[idx];
  questionEl.textContent = `${a} Ã— ${b} = ?`;
  progressEl.textContent = `ç¬¬ ${idx+1} / ${q.length} é¡Œ`;
  sec = 8;
  timerEl.textContent = `â± ${sec}`;
  // start timer
  const myToken = ++idx; // use idx as token (1-based)
  // store start time (we'll compute used time as 8 - sec when correct)
  const startTime = performance.now();
  timerId = setInterval(()=>{
    // if idx changed below, we must ignore (token check)
    // but we used idx++ above to set current index; so we need another variable to track question index.
  }, 0);
  // Implement proper timer using closure:
  const currentIndex = idx - 1; // zero-based index of current question
  clearInterval(timerId);
  timerId = setInterval(()=>{
    // ensure still same question
    if(currentIndex !== (idx - 1)) return;
    sec--;
    beep(700,0.05,0.08); // ticking
    timerEl.textContent = `â± ${sec}`;
    if(sec <= 0){
      clearInterval(timerId);
      // mark wrong due to timeout
      handleMark(false);
    }
  },1000);
  // store question start time for measuring correct time
  q[currentIndex].__start = performance.now();
}

/* ================= è¼¸å…¥ / é¡¯ç¤º ================= */
function renderAnswer(){
  answerBox.textContent = ans || '';
  // default color
  answerBox.style.color = '#1890ff';
  // if ans is showing correct-answer-display temporarily, we preserve color when set elsewhere
}

function press(digit){
  if(ans.length >= 2) return;
  ans += digit;
  renderAnswer();
  // check whether to auto-judge
  const cur = q[idx - 1]; // zero-based
  const correctAns = cur.a * cur.b;
  if(correctAns < 10 && ans.length === 1){
    handleMark(Number(ans) === correctAns);
  } else if(correctAns >= 10 && ans.length === 2){
    handleMark(Number(ans) === correctAns);
  }
}

function del(){
  if(!running) return;
  if(ans.length>0) ans = ans.slice(0,-1);
  renderAnswer();
}

/* ================= åˆ¤å®šèˆ‡å›é¥‹ ================= */
function handleMark(isCorrect){
  // Prevent double-handling: clear timer and set running state for current question
  clearInterval(timerId);

  const curIndex = idx - 1;
  const cur = q[curIndex];
  const correctAns = cur.a * cur.b;

  if(isCorrect){
    correct++;
    // compute used time (in seconds)
    const usedMs = (performance.now() - (cur.__start || performance.now()));
    const usedS = Math.max(0, (8 - Math.round((performance.now() - cur.__start)/1000))); // approximate; fallback
    // better compute accurate used time:
    const accurateUsed = ((performance.now() - cur.__start)/1000);
    correctTimes.push(accurateUsed);
    // play correct sound
    ding();
    // small delay before next
    setTimeout(()=>{ next(); }, 300);
  } else {
    wrong++;
    wrongDetail.push(`${cur.a} Ã— ${cur.b} = ${correctAns}`);
    // show correct answer visually in answerBox (red) for 1.2s
    answerBox.textContent = `${correctAns}`;
    answerBox.style.color = '#d32f2f';
    // speak "ç­”éŒ¯äº†"
    speak('ç­”éŒ¯äº†');
    // short beep as error accent
    beep(400,0.12,0.12);
    setTimeout(()=>{ 
      // clear display and continue
      answerBox.textContent = '';
      answerBox.style.color = '#1890ff';
      next();
    }, 1200);
  }
}

/* ================= çµæŸ / æˆç¸¾å½ˆçª— ================= */
function finish(){
  running = false;
  // speak finish
  speak('æ­å–œä½ å®Œæˆæ¸¬é©—');
  // compute average based on correctTimes (seconds)
  const avg = correctTimes.length ? (correctTimes.reduce((a,b)=>a+b,0)/correctTimes.length).toFixed(1) : 0;
  quizCard.style.display = 'none';
  // build detail HTML
  let detailHTML = '';
  if(wrongDetail.length === 0) detailHTML = '<div class="wrongItem">ğŸ‰ å…¨å°ï¼</div>';
  else detailHTML = wrongDetail.map(w => `<div class="wrongItem">âŒ ${w}</div>`).join('');
  resultCard.innerHTML = `
    <div class="resultHeader">ğŸ“˜ æˆç¸¾å–®</div>
    <div class="scoreRow"><span>âœ” ç­”å°</span><span>${correct}</span></div>
    <div class="scoreRow"><span>âœ– ç­”éŒ¯</span><span>${wrong}</span></div>
    <div class="avgTime">â± å¹³å‡ä½œç­”æ™‚é–“ ${avg} ç§’</div>
    <button class="resultBtn retry" onclick="retryWrong()">ğŸ” éŒ¯é¡Œé‡ç·´</button>
    <button class="resultBtn restart" onclick="location.reload()">ğŸ“ é‡æ–°æ¸¬é©—</button>
    <div class="wrongList">${detailHTML}</div>
  `;
  resultOverlay.style.display = 'flex';
}

/* ================= éŒ¯é¡Œé‡ç·´ ================= */
function retryWrong(){
  if(wrongDetail.length === 0) return;
  // reconstruct list from wrongDetail strings "a Ã— b = c"
  const list = wrongDetail.map(s=>{
    const m = s.match(/(\d+)\s*Ã—\s*(\d+)/);
    return { a: Number(m[1]), b: Number(m[2]) };
  });
  resultOverlay.style.display = 'none';
  quizCard.style.display = 'block';
  // reset and start with list
  q = list;
  idx = 0; ans=''; correct=0; wrong=0; correctTimes=[]; wrongDetail=[];
  running = true;
  next();
}

/* ================= helper: safety ================= */
window.addEventListener('pagehide', ()=>{ clearInterval(timerId); });
</script>
</body>
</html>
