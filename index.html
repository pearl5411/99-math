<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>99乘法考試</title>

<style>
body{
 font-family:"Noto Sans TC",system-ui;
 background:#fff7e6;
 text-align:center;
 margin:0;padding:10px;
}
h1{color:#ff7a00;}
#card{
 background:#fff;
 border-radius:16px;
 padding:16px;
 max-width:420px;
 margin:auto;
 box-shadow:0 4px 10px rgba(0,0,0,.15);
}
#question{font-size:36px;margin:10px 0;}
#input{font-size:32px;color:#1890ff;height:40px;}
#timer{color:#ff4d4f;font-size:20px;}
#progress{font-size:18px;}
#reveal{font-size:28px;color:red;display:none;}
#pad{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:10px;margin-top:10px;
}
button{
 font-size:24px;padding:14px;
 border:none;border-radius:12px;
 background:#ffd591;
}
button:active{background:#ffb84d;}
#startBtn{background:#52c41a;color:#fff;margin-top:10px;}
#resultBox{
 display:none;background:#fff;
 border-radius:16px;padding:20px;margin-top:20px;
}
.big{font-size:26px;font-weight:bold;}
.detail{color:#ff4d4f;margin-top:10px;}
</style>
</head>

<body>
<h1>99乘法考試</h1>

<div id="card">
 <div id="progress"></div>
 <div id="timer"></div>
 <div id="question">請按開始</div>
 <div id="input"></div>
 <div id="reveal"></div>
 <div id="pad"></div>
 <button id="startBtn">開始測驗</button>
</div>

<div id="resultBox"></div>

<audio id="beep" src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="></audio>
<audio id="ding" src="data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YYAAAAA="></audio>

<script>
let questions=[],wrongList=[];
let index=0,a,b,answer;
let sec=8,timerId;
let answered=false,running=false;
let token=0;
let inputBuffer="";
let correct=0,wrong=0;
let totalCorrectTime=0,startTime=0;

const qEl=question, tEl=timer, pEl=progress;
const rEl=reveal, inputEl=input, padEl=pad;
const resultBox=document.getElementById("resultBox");

for(let i=1;i<=9;i++){
 let b=document.createElement("button");
 b.textContent=i;
 b.onclick=()=>submit(i);
 padEl.appendChild(b);
}

function play(id){
 const a=document.getElementById(id);
 a.currentTime=0;a.play().catch(()=>{});
}
function speak(t){
 speechSynthesis.cancel();
 speechSynthesis.speak(new SpeechSynthesisUtterance(t));
}

startBtn.onclick=()=>{
 if(running) return;
 running=true;
 questions=[];wrongList=[];
 correct=wrong=totalCorrectTime=0;
 for(let i=0;i<30;i++)
  questions.push({a:rand(),b:rand()});
 index=0;
 resultBox.style.display="none";
 next();
};

function rand(){return Math.floor(Math.random()*9)+1;}

function next(){
 clearInterval(timerId);
 answered=false;inputBuffer="";
 inputEl.textContent="";
 rEl.style.display="none";
 token++;

 if(index>=questions.length){finish();return;}

 ({a,b}=questions[index]);
 answer=a*b;
 startTime=Date.now();

 pEl.textContent=`第 ${index+1} / ${questions.length} 題`;
 qEl.textContent=`${a} × ${b} = ?`;
 startTimer(token);
}

function startTimer(tk){
 sec=8;
 tEl.textContent=`剩 ${sec} 秒`;
 timerId=setInterval(()=>{
  if(tk!==token) return;
  sec--; play("beep");
  tEl.textContent=`剩 ${sec} 秒`;
  if(sec<=0){
   clearInterval(timerId);
   if(answered) return;
   answered=true;
   wrong++;
   wrongList.push({a,b,answer,user:null});
   rEl.textContent=`${a} × ${b} = ${answer}`;
   rEl.style.display="block";
   speak("答錯了");
   setTimeout(()=>{index++;next();},2000);
  }
 },1000);
}

function submit(n){
 if(answered||!running) return;
 inputBuffer+=n;
 inputEl.textContent=inputBuffer;
 if(inputBuffer.length < String(answer).length) return;

 answered=true; clearInterval(timerId);

 if(Number(inputBuffer)===answer){
  correct++;
  totalCorrectTime+=(Date.now()-startTime)/1000;
  play("ding");play("ding");
 }else{
  wrong++;
  wrongList.push({a,b,answer,user:Number(inputBuffer)});
  rEl.textContent=`${a} × ${b} = ${answer}`;
  rEl.style.display="block";
  speak("答錯了");
 }
 setTimeout(()=>{index++;next();},2000);
}

function finish(){
 running=false;
 speak("恭喜你完成測驗");
 const avg=correct?(totalCorrectTime/correct).toFixed(1):0;

 let detailHTML="";
 wrongList.forEach(q=>{
  detailHTML+=`<div class="detail">${q.a}×${q.b}＝${q.answer}（你答：${q.user??"未答"}）</div>`;
 });

 resultBox.innerHTML=`
 <div class="big">測驗完成</div><br>
 ✔ 答對：${correct} 題<br>
 ✖ 答錯：${wrong} 題<br>
 ⏱ 平均答對時間：${avg} 秒<br><br>
 <button onclick="location.reload()">重新測驗</button>
 <button onclick="retryWrong()">錯題重練</button>
 <div>${detailHTML}</div>
 `;
 resultBox.style.display="block";
}

function retryWrong(){
 if(wrongList.length===0) return;
 questions = wrongList.map(q=>({a:q.a,b:q.b}));
 wrongList=[];index=0;
 correct=wrong=totalCorrectTime=0;
 resultBox.style.display="none";
 running=true;
 next();
}
</script>
</body>
</html>
