<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>99ä¹˜æ³•æ¸¬é©—</title>

<style>
body{
 margin:0;
 font-family:system-ui;
 background:#f4f6f8;
 text-align:center;
}
.container{
 max-width:420px;
 margin:auto;
 padding:20px;
}
.hidden{display:none;}

h1{margin-bottom:10px;}
.question{font-size:36px;margin:20px 0;}
.timer{font-size:28px;color:#d32f2f;}
.progress{font-size:18px;margin:10px;}

.keypad{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:12px;
 margin-top:20px;
}
button{
 font-size:22px;
 padding:16px;
 border:none;
 border-radius:12px;
 background:#fff;
 box-shadow:0 4px 8px rgba(0,0,0,.15);
}
button:active{transform:scale(.95);}
.start-btn{
 background:#1976d2;
 color:#fff;
 font-size:26px;
}

/* æˆç¸¾å–® */
.score-sheet{
 background:#fff;
 border:2px solid #ccc;
 border-radius:12px;
 padding:20px;
 margin-top:20px;
}
.sheet-title{
 font-size:22px;
 font-weight:bold;
 letter-spacing:4px;
 margin-bottom:15px;
}
.sheet-row{
 display:flex;
 justify-content:space-between;
 font-size:18px;
 padding:6px 0;
 border-bottom:1px dashed #ccc;
}
.highlight{
 font-weight:bold;
 color:#d32f2f;
 border-bottom:none;
}
.detail-btn{
 margin:10px 0;
 padding:8px;
 font-size:16px;
}
.detailBox{
 max-height:0;
 overflow:hidden;
 transition:max-height .4s ease;
}
.detailBox.open{max-height:240px;}
.detailBox div{
 color:#c62828;
 font-size:17px;
 padding:4px 0;
}
.action-btn{
 margin-top:12px;
 font-size:18px;
 padding:10px;
 background:#1976d2;
 color:#fff;
}
</style>
</head>

<body>
<div class="container">

<h1>99 ä¹˜æ³•æ¸¬é©—</h1>

<div id="start">
 <button class="start-btn" onclick="startExam()">é–‹å§‹æ¸¬é©—</button>
</div>

<div id="exam" class="hidden">
 <div class="progress" id="progress"></div>
 <div class="timer" id="timer">8</div>
 <div class="question" id="question"></div>
 <div class="keypad" id="keypad"></div>
</div>

<div id="result" class="hidden">
 <div class="score-sheet">
  <div class="sheet-title">99 ä¹˜ æ³• æ¸¬ é©—</div>

  <div class="sheet-row"><span>è€ƒè©¦é¡Œæ•¸</span><span>30 é¡Œ</span></div>
  <div class="sheet-row"><span>ç­”å°é¡Œæ•¸</span><span id="correctCount"></span></div>
  <div class="sheet-row"><span>éŒ¯èª¤é¡Œæ•¸</span><span id="wrongCount"></span></div>
  <div class="sheet-row highlight">
   <span>å¹³å‡ä½œç­”æ™‚é–“</span><span id="avgTime"></span>
  </div>

  <button class="detail-btn" id="detailBtn" onclick="toggleDetail()">
   æŸ¥çœ‹éŒ¯èª¤æ˜ç´° â–¼
  </button>

  <div class="detailBox" id="detailBox">
   <div id="detailList"></div>
  </div>

  <button id="retryBtn" class="action-btn" onclick="startRetry()" style="display:none">
   éŒ¯é¡Œé‡ç·´
  </button>

  <button class="action-btn" onclick="restart()">é‡æ–°æ¸¬é©—</button>
 </div>
</div>

</div>

<script>
/* ===== è²éŸ³ç³»çµ±ï¼ˆæœ€ç©©å®šå¯«æ³•ï¼‰ ===== */
let audioCtx=null;

function unlockAudio(){
 if(!audioCtx){
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
 }
 audioCtx.resume().catch(()=>{});
}

function beep(freq=800,duration=0.07){
 if(!audioCtx)return;
 const o=audioCtx.createOscillator();
 const g=audioCtx.createGain();
 o.connect(g); g.connect(audioCtx.destination);
 o.frequency.value=freq;
 g.gain.value=0.15;
 o.start();
 o.stop(audioCtx.currentTime+duration);
}

function correctSound(){
 beep(900,0.08);
 setTimeout(()=>beep(1200,0.08),120);
}

function wrongSound(){
 if(!('speechSynthesis' in window))return;
 const u=new SpeechSynthesisUtterance("ç­”éŒ¯äº†");
 u.lang="zh-TW";
 speechSynthesis.cancel();
 speechSynthesis.speak(u);
}

/* ===== è€ƒè©¦é‚è¼¯ ===== */
let total=30,idx=0,a,b;
let timer=8,tId,answer="";
let correct=0;
let correctTimes=[];
let wrongDetails=[],wrongQuestions=[];
let retryMode=false,retryList=[];
let startTime=0;

function startExam(){
 unlockAudio();
 document.getElementById("start").classList.add("hidden");
 document.getElementById("exam").classList.remove("hidden");
 idx=0;correct=0;
 correctTimes=[];wrongDetails=[];wrongQuestions=[];
 retryMode=false;
 nextQ();
}

function nextQ(){
 if(idx>=total){finish();return;}
 idx++;
 if(retryMode){
  const q=retryList[idx-1];
  a=q.a;b=q.b;
 }else{
  a=Math.floor(Math.random()*9)+1;
  b=Math.floor(Math.random()*9)+1;
 }
 answer=""; timer=8;
 startTime=Date.now();
 updateUI();
 startTimer();
}

function updateUI(){
 document.getElementById("progress").textContent=
  retryMode?`éŒ¯é¡Œé‡ç·´ ${idx}/${total}`:`ç¬¬ ${idx}/${total} é¡Œ`;
 document.getElementById("question").textContent=`${a} Ã— ${b} = ?`;
 document.getElementById("timer").textContent=timer;
 drawKeys();
}

function startTimer(){
 clearInterval(tId);
 tId=setInterval(()=>{
  timer--;
  document.getElementById("timer").textContent=timer;
  beep(700,0.05);          // â±ï¸ æ¯ç§’æ»´è²
  if(timer<=0){
   recordWrong();
   wrongSound();
   clearInterval(tId);
   setTimeout(nextQ,500);
  }
 },1000);
}

function drawKeys(){
 const k=document.getElementById("keypad");
 k.innerHTML="";
 for(let i=0;i<=9;i++){
  const btn=document.createElement("button");
  btn.textContent=i;
  btn.onclick=()=>answer+=i;
  k.appendChild(btn);
 }
 const del=document.createElement("button");
 del.textContent="âŒ«";
 del.onclick=()=>answer=answer.slice(0,-1);
 k.appendChild(del);
 const ok=document.createElement("button");
 ok.textContent="OK";
 ok.onclick=check;
 k.appendChild(ok);
}

function check(){
 if(answer==="")return;
 clearInterval(tId);
 if(Number(answer)===a*b){
  correct++;
  correctTimes.push((Date.now()-startTime)/1000);
  correctSound();
 }else{
  recordWrong();
  wrongSound();
 }
 setTimeout(nextQ,400);
}

function recordWrong(){
 wrongDetails.push(`${a} Ã— ${b} = ${a*b}`);
 if(!retryMode) wrongQuestions.push({a,b});
}

function finish(){
 document.getElementById("exam").classList.add("hidden");
 document.getElementById("result").classList.remove("hidden");

 document.getElementById("correctCount").textContent=correct+" é¡Œ";
 document.getElementById("wrongCount").textContent=(total-correct)+" é¡Œ";

 const avg=correctTimes.length
 ?(correctTimes.reduce((x,y)=>x+y)/correctTimes.length).toFixed(1)
 :0;
 document.getElementById("avgTime").textContent=avg+" ç§’";

 document.getElementById("detailList").innerHTML=
  wrongDetails.length
  ?wrongDetails.map(x=>`<div>${x}</div>`).join("")
  :"æ²’æœ‰éŒ¯èª¤ ğŸ‰";

 if(wrongQuestions.length>0 && !retryMode){
  document.getElementById("retryBtn").style.display="block";
  document.getElementById("retryBtn").textContent=
   `éŒ¯é¡Œé‡ç·´ï¼ˆ${wrongQuestions.length} é¡Œï¼‰`;
 }
}

let detailOpen=false;
function toggleDetail(){
 detailOpen=!detailOpen;
 document.getElementById("detailBox").classList.toggle("open",detailOpen);
 document.getElementById("detailBtn").textContent=
  detailOpen?"æ”¶èµ·éŒ¯èª¤æ˜ç´° â–²":"æŸ¥çœ‹éŒ¯èª¤æ˜ç´° â–¼";
}

function startRetry(){
 retryMode=true;
 retryList=[...wrongQuestions];
 shuffle(retryList);
 total=retryList.length;
 idx=0;correct=0;
 correctTimes=[];wrongDetails=[];
 document.getElementById("result").classList.add("hidden");
 document.getElementById("exam").classList.remove("hidden");
 nextQ();
}

function shuffle(arr){
 for(let i=arr.length-1;i>0;i--){
  const j=Math.floor(Math.random()*(i+1));
  [arr[i],arr[j]]=[arr[j],arr[i]];
 }
}

function restart(){location.reload();}
</script>
</body>
</html>
