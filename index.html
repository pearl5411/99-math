<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>99ä¹˜æ³•æ¸¬é©—</title>

<style>
body{
  margin:0;
  font-family:"Noto Sans TC",system-ui;
  background:#fff3e0;
  text-align:center;
}
h1{color:#ff7043}

.card{
  background:#fff;
  margin:16px;
  padding:16px;
  border-radius:24px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}

#progress{
  font-size:18px;
  color:#8d6e63;
  margin-bottom:4px;
}
#question{font-size:34px}
#timer{font-size:22px;color:#d84315}

/* ç­”æ¡ˆæ¡† */
#answerWrap{
  position:relative;
  width:120px;
  margin:12px auto 6px;
}
#answerBox{
  border:4px solid #ffccbc;
  border-radius:14px;
  font-size:28px;
  padding:6px;
  min-height:36px;
  color:#1890ff;
  background:#fff;
}

/* å“­è‡‰ */
.cry{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  font-size:42px;
  opacity:0;
  pointer-events:none;
}
.cry.left{left:-48px}
.cry.right{right:-48px}

@keyframes cryAnim{
  0%{opacity:0;transform:translateY(-50%) scale(.5);}
  30%{opacity:1;transform:translateY(-50%) scale(1.1);}
  100%{opacity:0;transform:translateY(-50%) scale(.6);}
}
.showCry{animation:cryAnim 1.2s}

#correctHint{
  font-size:20px;
  color:#d32f2f;
  min-height:26px;
}

/* éµç›¤ */
.keypad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  max-width:280px;
  margin:12px auto;
}
.keypad button{
  font-size:30px;
  padding:18px;
  border:none;
  border-radius:18px;
  background:#ffab91;
}

/* æˆç¸¾å–®é®ç½© */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  justify-content:center;
  align-items:center;
}

/* æˆç¸¾å–®ï¼ˆç²‰å«©è²¼ç´™æ„Ÿï¼‰ */
.resultCard{
  background:#fffdf7;
  border-radius:28px;
  padding:22px;
  width:90%;
  max-width:360px;
  border:4px dashed #ffb6c1;
  box-shadow:
    0 6px 0 #ffd1dc,
    0 12px 18px rgba(0,0,0,.18);
}

/* æˆç¸¾æ¨™é¡Œï¼ˆæ–¹æ¡ˆ Dï¼‰ */
.cuteHeader{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:12px;
  margin-bottom:6px;
}
.cuteHeader .decor{font-size:30px}
.cuteHeader .title{
  font-size:32px;
  font-weight:bold;
  color:#ff6f61;
}

.scoreRow{
  text-align:center;
  font-size:22px;
  margin:8px 0;
}

.resultBtn{
  width:100%;
  margin-top:10px;
  font-size:20px;
  padding:10px;
  border:none;
  border-radius:16px;
}
.retry{background:#52c41a;color:white}
.restart{background:#1890ff;color:white}

.detail{
  background:#fff1f0;
  border-radius:14px;
  padding:10px;
  margin-top:10px;
  text-align:left;
  display:none;
}
.detailItem{
  font-size:20px;
  margin-bottom:6px;
}
</style>
</head>

<body>
<h1>99ä¹˜æ³•æ¸¬é©—</h1>

<div class="card" id="startCard">
  <button class="resultBtn restart" id="startBtn">â–¶ é–‹å§‹æ¸¬é©—</button>
</div>

<div class="card" id="quizCard" style="display:none">
  <div id="progress"></div>
  <div id="question"></div>
  <div id="timer"></div>

  <div id="answerWrap">
    <div class="cry left">ğŸ˜­</div>
    <div id="answerBox"></div>
    <div class="cry right">ğŸ˜­</div>
  </div>

  <div id="correctHint"></div>
  <div class="keypad" id="pad"></div>
</div>

<div class="overlay" id="resultOverlay">
  <div class="resultCard" id="resultCard"></div>
</div>

<script>
let audioCtx;
function initAudio(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    audioCtx.resume();
  }
}
function beep(f=800,t=.05){
  if(!audioCtx)return;
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=f; g.gain.value=.12;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+t);
  o.stop(audioCtx.currentTime+t);
}
function ding(){beep(1200,.08);setTimeout(()=>beep(1500,.08),120)}
function speak(t){
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(t);
  u.lang="zh-TW";
  speechSynthesis.speak(u);
}

function showCry(){
  document.querySelectorAll(".cry").forEach(c=>{
    c.classList.remove("showCry");
    void c.offsetWidth;
    c.classList.add("showCry");
  });
}

let list=[],i=0,ans="",sec=8,timer;
let wrong=[],correct=0,totalCorrectTime=0,qStartTime=0;

const startBtn=document.getElementById("startBtn");
const startCard=document.getElementById("startCard");
const quizCard=document.getElementById("quizCard");
const qEl=document.getElementById("question");
const tEl=document.getElementById("timer");
const aEl=document.getElementById("answerBox");
const hint=document.getElementById("correctHint");
const pad=document.getElementById("pad");
const overlay=document.getElementById("resultOverlay");
const resultCard=document.getElementById("resultCard");
const progress=document.getElementById("progress");

["1","2","3","4","5","6","7","8","9","del","0"].forEach(k=>{
  const b=document.createElement("button");
  b.textContent=k==="del"?"âŒ«":k;
  b.onclick=()=>k==="del"?del():press(k);
  pad.appendChild(b);
});

startBtn.onclick=()=>{
  initAudio();
  list=Array.from({length:30},()=>({
    a:1+Math.floor(Math.random()*9),
    b:1+Math.floor(Math.random()*9)
  }));
  i=0;correct=0;wrong=[];totalCorrectTime=0;
  startCard.style.display="none";
  quizCard.style.display="block";
  next();
};

function next(){
  clearInterval(timer);
  ans="";aEl.textContent="";hint.textContent="";
  if(i>=list.length)return finish();
  const q=list[i];
  progress.textContent=`ç¬¬ ${i+1} / ${list.length} é¡Œ`;
  qEl.textContent=`${q.a} Ã— ${q.b} = ?`;
  sec=8;tEl.textContent=`â± ${sec}`;
  qStartTime=Date.now();
  timer=setInterval(()=>{
    sec--;beep(700);
    tEl.textContent=`â± ${sec}`;
    if(sec<=0)mark(false);
  },1000);
}

function press(d){
  if(ans.length>=2)return;
  ans+=d;aEl.textContent=ans;
  const q=list[i],c=q.a*q.b;
  if((c<10&&ans.length===1)||(c>=10&&ans.length===2))
    mark(Number(ans)===c);
}
function del(){
  ans=ans.slice(0,-1);
  aEl.textContent=ans;
}

function mark(ok){
  clearInterval(timer);
  const q=list[i],c=q.a*q.b;
  if(ok){
    correct++;
    totalCorrectTime+=(Date.now()-qStartTime)/1000;
    ding();
    i++;setTimeout(next,300);
  }else{
    showCry();
    wrong.push(`${q.a} Ã— ${q.b} = ${c}ï¼ˆä½ çš„ç­”æ¡ˆï¼š${ans||"æœªè¼¸å…¥"}ï¼‰`);
    hint.textContent=`æ­£ç¢ºç­”æ¡ˆï¼š${c}`;
    speak("ç­”éŒ¯äº†");
    i++;setTimeout(next,2000);
  }
}

function finish(){
  speak("æ­å–œä½ å®Œæˆæ¸¬é©—");
  quizCard.style.display="none";
  let html=wrong.map(w=>`<div class="detailItem">${w}</div>`).join("");
  resultCard.innerHTML=`
    <div class="cuteHeader">
      <span class="decor">ğŸ’—</span>
      <span class="title">ğŸ“˜ æˆç¸¾å–®</span>
      <span class="decor">ğŸ’—</span>
    </div>
    <div class="scoreRow">ç­”å°é¡Œæ•¸ï¼š${correct}</div>
    <div class="scoreRow">ç­”éŒ¯é¡Œæ•¸ï¼š${wrong.length}</div>
    <div class="scoreRow">â± å¹³å‡æ™‚é–“ï¼š${correct?(totalCorrectTime/correct).toFixed(1)+" ç§’":"-"}</div>
    <button class="resultBtn retry" onclick="retry()">éŒ¯é¡Œé‡ç·´</button>
    <button class="resultBtn restart" onclick="location.reload()">é‡æ–°æ¸¬é©—</button>
    <button class="resultBtn" onclick="toggle()">æŸ¥çœ‹éŒ¯èª¤æ˜ç´°</button>
    <div class="detail" id="detail">${html||"ğŸ‰ å…¨å°ï¼"}</div>
  `;
  overlay.style.display="flex";
}

function toggle(){
  const d=document.getElementById("detail");
  d.style.display=d.style.display==="none"?"block":"none";
}
function retry(){
  list=wrong.map(w=>{
    const m=w.match(/(\d+)\sÃ—\s(\d+)/);
    return {a:+m[1],b:+m[2]};
  });
  i=0;wrong=[];correct=0;totalCorrectTime=0;
  overlay.style.display="none";
  quizCard.style.display="block";
  next();
}
</script>
</body>
</html>
