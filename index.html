<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>99ä¹˜æ³•è€ƒè©¦</title>

<style>
body{
 font-family:"Noto Sans TC",system-ui;
 background:#fff7e6;
 text-align:center;
 margin:0;padding:10px;
}
h1{color:#ff7a00;}
#card{
 background:#fff;
 border-radius:16px;
 padding:16px;
 max-width:420px;
 margin:auto;
 box-shadow:0 4px 10px rgba(0,0,0,.15);
}
#question{font-size:36px;margin:10px 0;}
#input{font-size:32px;color:#1890ff;height:40px;}
#timer{color:#ff4d4f;font-size:20px;}
#progress{font-size:18px;}
#reveal{font-size:28px;color:red;display:none;}
#pad{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:10px;margin-top:10px;
}
button{
 font-size:24px;padding:14px;
 border:none;border-radius:12px;
 background:#ffd591;
}
button:active{background:#ffb84d;}
#startBtn{background:#52c41a;color:#fff;margin-top:10px;}
#resultBox{
 display:none;background:#fff;
 border-radius:16px;padding:20px;margin-top:20px;
}
.big{font-size:26px;font-weight:bold;}
.detail{color:#ff4d4f;margin-top:6px;}
</style>
</head>

<body>
<h1>99ä¹˜æ³•è€ƒè©¦</h1>

<div id="card">
 <div id="progress"></div>
 <div id="timer"></div>
 <div id="question">è«‹æŒ‰é–‹å§‹</div>
 <div id="input"></div>
 <div id="reveal"></div>
 <div id="pad"></div>
 <button id="startBtn">é–‹å§‹æ¸¬é©—</button>
</div>

<div id="resultBox"></div>

<script>
/* ========= Web Audioï¼ˆiOS ç©©å®šï¼‰ ========= */
let audioCtx = null;

function initAudio(){
 if(audioCtx) return;
 audioCtx = new (window.AudioContext||window.webkitAudioContext)();
}

function beep(freq=800, duration=0.08){
 if(!audioCtx) return;
 const o = audioCtx.createOscillator();
 const g = audioCtx.createGain();
 o.frequency.value = freq;
 g.gain.value = 0.12;
 o.connect(g); g.connect(audioCtx.destination);
 o.start();
 o.stop(audioCtx.currentTime + duration);
}

function ding(){
 beep(1200,0.1);
 setTimeout(()=>beep(1500,0.1),120);
}

function speak(text){
 speechSynthesis.cancel();
 speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}

/* ========= ç‹€æ…‹ ========= */
let questions=[], wrongList=[];
let index=0,a,b,answer;
let sec=8,timerId;
let answered=false,running=false;
let token=0,inputBuffer="";
let correct=0,wrong=0,totalCorrectTime=0,startTime=0;

/* ========= DOM ========= */
const qEl = document.getElementById("question");
const tEl = document.getElementById("timer");
const pEl = document.getElementById("progress");
const rEl = document.getElementById("reveal");
const inputEl = document.getElementById("input");
const padEl = document.getElementById("pad");
const resultBox = document.getElementById("resultBox");
const startBtn = document.getElementById("startBtn");

/* ========= æ•¸å­—éµï¼ˆå« 0ï¼‰ ========= */
[1,2,3,4,5,6,7,8,9,0].forEach(n=>{
 const btn=document.createElement("button");
 btn.textContent=n;
 btn.onclick=()=>submit(n);
 padEl.appendChild(btn);
});

/* ========= é–‹å§‹ ========= */
startBtn.onclick=()=>{
 initAudio();        // ğŸ”“ è§£é–è²éŸ³
 beep(1,0.01);       // iOS å¿…é ˆçš„ç¬¬ä¸€æ¬¡è²éŸ³

 if(running) return;
 running=true;

 questions=[]; wrongList=[];
 correct=wrong=totalCorrectTime=0;
 index=0;

 for(let i=0;i<30;i++){
  questions.push({
   a:Math.floor(Math.random()*9)+1,
   b:Math.floor(Math.random()*9)+1
  });
 }

 resultBox.style.display="none";
 next();
};

/* ========= ä¸‹ä¸€é¡Œ ========= */
function next(){
 clearInterval(timerId);
 answered=false;
 inputBuffer="";
 inputEl.textContent="";
 rEl.style.display="none";
 token++;

 if(index>=questions.length){
  finish();
  return;
 }

 ({a,b}=questions[index]);
 answer=a*b;
 startTime=Date.now();

 pEl.textContent=`ç¬¬ ${index+1} / ${questions.length} é¡Œ`;
 qEl.textContent=`${a} Ã— ${b} = ?`;

 startTimer(token);
}

/* ========= è¨ˆæ™‚ ========= */
function startTimer(myToken){
 sec=8;
 tEl.textContent=`å‰© ${sec} ç§’`;
 timerId=setInterval(()=>{
  if(myToken!==token) return;
  sec--;
  beep(700,0.05);   // ğŸ”” è¨ˆæ™‚è²
  tEl.textContent=`å‰© ${sec} ç§’`;

  if(sec<=0){
   clearInterval(timerId);
   if(answered) return;
   answered=true;
   wrong++;
   wrongList.push({a,b,answer,user:null});
   rEl.textContent=`${a} Ã— ${b} = ${answer}`;
   rEl.style.display="block";
   speak("ç­”éŒ¯äº†");
   setTimeout(()=>{index++;next();},2000);
  }
 },1000);
}

/* ========= ä½œç­” ========= */
function submit(n){
 if(answered||!running) return;

 inputBuffer+=n;
 inputEl.textContent=inputBuffer;

 if(inputBuffer.length < String(answer).length) return;

 answered=true;
 clearInterval(timerId);

 if(Number(inputBuffer)===answer){
  correct++;
  totalCorrectTime+=(Date.now()-startTime)/1000;
  ding();            // âœ… ç­”å°éŸ³
 }else{
  wrong++;
  wrongList.push({a,b,answer,user:Number(inputBuffer)});
  rEl.textContent=`${a} Ã— ${b} = ${answer}`;
  rEl.style.display="block";
  speak("ç­”éŒ¯äº†");
 }

 setTimeout(()=>{index++;next();},2000);
}

/* ========= çµæŸ ========= */
function finish(){
 running=false;
 speak("æ­å–œä½ å®Œæˆæ¸¬é©—");
 const avg=correct?(totalCorrectTime/correct).toFixed(1):0;

 let detail="";
 wrongList.forEach(q=>{
  detail+=`<div class="detail">${q.a}Ã—${q.b}ï¼${q.answer}ï¼ˆä½ ç­”ï¼š${q.user??"æœªç­”"}ï¼‰</div>`;
 });

 resultBox.innerHTML=`
 <div class="big">æ¸¬é©—å®Œæˆ</div><br>
 âœ” ç­”å°ï¼š${correct} é¡Œ<br>
 âœ– ç­”éŒ¯ï¼š${wrong} é¡Œ<br>
 â± å¹³å‡ç­”å°æ™‚é–“ï¼š${avg} ç§’<br><br>
 <button onclick="location.reload()">é‡æ–°æ¸¬é©—</button>
 <button onclick="retryWrong()">éŒ¯é¡Œé‡ç·´</button>
 <div>${detail}</div>
 `;
 resultBox.style.display="block";
}

function retryWrong(){
 if(wrongList.length===0) return;
 questions = wrongList.map(q=>({a:q.a,b:q.b}));
 wrongList=[];
 index=0;
 correct=wrong=totalCorrectTime=0;
 resultBox.style.display="none";
 running=true;
 next();
}
</script>
</body>
</html>
