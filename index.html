<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>99ä¹˜æ³•å°è€ƒ</title>

<style>
body{
 font-family:"Noto Sans TC",system-ui;
 background:#fff1f0;
 margin:0;padding:12px;
 text-align:center;
}
h1{color:#ff6f61;margin:10px 0;}
#card{
 background:#ffffff;
 border-radius:20px;
 padding:18px;
 max-width:420px;
 margin:auto;
 box-shadow:0 8px 20px rgba(0,0,0,.15);
}
#progress{font-size:18px;color:#555;}
#timer{font-size:20px;color:#ff4d4f;margin:6px 0;}
#question{font-size:38px;margin:12px 0;}

#answerBox{
 border:3px dashed #91d5ff;
 border-radius:16px;
 background:#e6f7ff;
 font-size:36px;
 height:52px;
 line-height:52px;
 margin:10px auto;
 color:#1890ff;
 width:80%;
}

#reveal{
 font-size:28px;
 color:#ff4d4f;
 display:none;
 margin-top:6px;
}

#pad{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:12px;
 margin-top:14px;
}
button{
 font-size:26px;
 padding:16px;
 border:none;
 border-radius:18px;
 background:#ffd666;
}
button:active{background:#ffc53d;}

.del{
 background:#ffccc7;
 color:#a8071a;
}

#startBtn{
 background:#52c41a;
 color:#fff;
 margin-top:12px;
 width:100%;
 font-size:24px;
}

/* ===== æˆç¸¾å½ˆçª— ===== */
#overlay{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.4);
 display:none;
 align-items:center;
 justify-content:center;
}
#resultBox{
 background:#fff;
 border-radius:24px;
 padding:22px;
 width:90%;
 max-width:420px;
 animation:pop .35s ease;
}
@keyframes pop{
 from{transform:scale(.7);opacity:0;}
 to{transform:scale(1);opacity:1;}
}
.big{font-size:30px;font-weight:bold;color:#ff6f61;}
.score{font-size:22px;margin:6px 0;}
.detail{
 color:#ff4d4f;
 font-size:16px;
 margin-top:4px;
}
.resultBtn{
 margin-top:10px;
 width:100%;
 font-size:22px;
 padding:12px;
 border-radius:16px;
 border:none;
}
.retry{background:#95de64;}
.restart{background:#ffd666;}
</style>
</head>

<body>
<h1>99 ä¹˜æ³•å°è€ƒ</h1>

<div id="card">
 <div id="progress"></div>
 <div id="timer"></div>
 <div id="question">è«‹æŒ‰é–‹å§‹</div>
 <div id="answerBox"></div>
 <div id="reveal"></div>
 <div id="pad"></div>
 <button id="startBtn">é–‹å§‹æ¸¬é©—</button>
</div>

<div id="overlay">
 <div id="resultBox"></div>
</div>

<script>
/* ===== Web Audio ===== */
let audioCtx=null;
function initAudio(){
 if(audioCtx) return;
 audioCtx=new (window.AudioContext||window.webkitAudioContext)();
}
function beep(f=700,d=0.06){
 if(!audioCtx) return;
 const o=audioCtx.createOscillator(),g=audioCtx.createGain();
 o.frequency.value=f; g.gain.value=0.12;
 o.connect(g); g.connect(audioCtx.destination);
 o.start(); o.stop(audioCtx.currentTime+d);
}
function ding(){
 beep(1200,0.1); setTimeout(()=>beep(1500,0.1),120);
}
function speak(t){
 speechSynthesis.cancel();
 speechSynthesis.speak(new SpeechSynthesisUtterance(t));
}

/* ===== DOM ===== */
const qEl=question, tEl=timer, pEl=progress;
const aEl=answerBox, rEl=reveal;
const padEl=pad, startBtn=startBtn;
const overlay=document.getElementById("overlay");
const resultBox=document.getElementById("resultBox");

/* ===== ç‹€æ…‹ ===== */
let questions=[],wrongList=[];
let index=0,a,b,answer;
let sec=8,timerId,token=0;
let input="",answered=false,running=false;
let correct=0,wrong=0,totalTime=0,startTime=0;

/* ===== æ•¸å­—éµ ===== */
[1,2,3,4,5,6,7,8,9,0].forEach(n=>{
 const btn=document.createElement("button");
 btn.textContent=n;
 btn.onclick=()=>submit(n);
 padEl.appendChild(btn);
});

/* ===== åˆªé™¤éµ ===== */
const delBtn=document.createElement("button");
delBtn.textContent="âŒ«";
delBtn.className="del";
delBtn.onclick=()=>{
 if(answered||!running) return;
 input=input.slice(0,-1);
 aEl.textContent=input;
};
padEl.appendChild(delBtn);

/* ===== é–‹å§‹ ===== */
startBtn.onclick=()=>{
 initAudio(); beep(1,0.01);
 if(running) return;
 running=true;
 questions=[]; wrongList=[];
 correct=wrong=totalTime=0;
 index=0;
 for(let i=0;i<30;i++)
  questions.push({a:r(),b:r()});
 overlay.style.display="none";
 next();
};
function r(){return Math.floor(Math.random()*9)+1;}

/* ===== ä¸‹ä¸€é¡Œ ===== */
function next(){
 clearInterval(timerId);
 answered=false; input="";
 aEl.textContent="";
 rEl.style.display="none";
 token++;
 if(index>=questions.length){finish();return;}
 ({a,b}=questions[index]);
 answer=a*b;
 startTime=Date.now();
 pEl.textContent=`ç¬¬ ${index+1} / ${questions.length} é¡Œ`;
 qEl.textContent=`${a} Ã— ${b} = ?`;
 startTimer(token);
}

/* ===== è¨ˆæ™‚ ===== */
function startTimer(tk){
 sec=8; tEl.textContent=`å‰© ${sec} ç§’`;
 timerId=setInterval(()=>{
  if(tk!==token) return;
  sec--; beep();
  tEl.textContent=`å‰© ${sec} ç§’`;
  if(sec<=0){
   clearInterval(timerId);
   if(answered) return;
   answered=true; wrong++;
   wrongList.push({a,b,answer,user:null});
   rEl.textContent=`${a} Ã— ${b} = ${answer}`;
   rEl.style.display="block";
   speak("ç­”éŒ¯äº†");
   setTimeout(()=>{index++;next();},2000);
  }
 },1000);
}

/* ===== ä½œç­” ===== */
function submit(n){
 if(answered||!running) return;
 input+=n; aEl.textContent=input;
 if(input.length < String(answer).length) return;
 answered=true; clearInterval(timerId);
 if(Number(input)===answer){
  correct++; totalTime+=(Date.now()-startTime)/1000;
  ding();
 }else{
  wrong++; wrongList.push({a,b,answer,user:Number(input)});
  rEl.textContent=`${a} Ã— ${b} = ${answer}`;
  rEl.style.display="block";
  speak("ç­”éŒ¯äº†");
 }
 setTimeout(()=>{index++;next();},2000);
}

/* ===== çµæŸ ===== */
function finish(){
 running=false;
 speak("æ­å–œä½ å®Œæˆæ¸¬é©—");
 const avg=correct?(totalTime/correct).toFixed(1):0;
 let detail="";
 wrongList.forEach(q=>{
  detail+=`<div class="detail">${q.a}Ã—${q.b}ï¼${q.answer}ï¼ˆä½ ç­”ï¼š${q.user??"æœªç­”"}ï¼‰</div>`;
 });
 resultBox.innerHTML=`
 <div class="big">æ¸¬é©—å®Œæˆ ğŸ‰</div>
 <div class="score">âœ” ç­”å°ï¼š${correct} é¡Œ</div>
 <div class="score">âœ– ç­”éŒ¯ï¼š${wrong} é¡Œ</div>
 <div class="score">â± å¹³å‡æ™‚é–“ï¼š${avg} ç§’</div>
 <button class="resultBtn retry" onclick="retryWrong()">éŒ¯é¡Œé‡ç·´</button>
 <button class="resultBtn restart" onclick="location.reload()">é‡æ–°æ¸¬é©—</button>
 ${detail}
 `;
 overlay.style.display="flex";
}

function retryWrong(){
 if(wrongList.length===0) return;
 questions=wrongList.map(q=>({a:q.a,b:q.b}));
 wrongList=[]; index=0;
 correct=wrong=totalTime=0;
 overlay.style.display="none";
 running=true;
 next();
}
</script>
</body>
</html>
