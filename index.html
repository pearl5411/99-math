<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
<title>99乘法考試</title>

<style>
body{
 font-family: -apple-system, BlinkMacSystemFont, sans-serif;
 background:#f6f7fb;
 margin:0;
 text-align:center;
}
.hidden{display:none}
h1{margin:10px 0}
#question{
 font-size:32px;
 margin:10px 0;
}
.answer{
 font-size:36px;
 min-height:44px;
 margin:10px 0;
}
#timer{
 font-size:20px;
 color:#555;
}
#reveal{
 font-size:26px;
 color:red;
 margin-top:8px;
 display:none;
}
.keypad{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:10px;
 padding:15px;
}
.keypad button{
 font-size:28px;
 padding:15px;
 border:none;
 border-radius:12px;
 background:#fff;
 box-shadow:0 2px 4px rgba(0,0,0,.15);
}
.keypad button:active{transform:scale(.95)}
.ok{background:#4caf50;color:#fff}
.del{background:#ff9800;color:#fff}

.score-sheet{
 background:#fff;
 margin:15px;
 padding:15px;
 border-radius:16px;
 box-shadow:0 3px 6px rgba(0,0,0,.2);
 text-align:left;
}
.score-sheet h2{text-align:center}
.score-big{
 font-size:22px;
 margin:8px 0;
}
button.restart-btn{
 width:100%;
 margin-top:10px;
 padding:14px;
 font-size:20px;
 border:none;
 border-radius:12px;
 background:#1976d2;
 color:#fff;
}
</style>
</head>

<body>

<h1>99 乘法考試</h1>

<div id="start">
<button class="restart-btn" onclick="startExam()">開始測驗</button>
</div>

<div id="exam" class="hidden">
<div id="progress"></div>
<div id="question"></div>
<div id="answer" class="answer">＿</div>
<div id="timer"></div>
<div id="reveal"></div>

<div class="keypad" id="keys"></div>
</div>

<div class="score-sheet hidden" id="score">
<h2>測驗成績單</h2>
<div class="score-big" id="scoreText"></div>
<div class="score-big" id="avgTime"></div>
<div class="score-big" id="wrongCount"></div>
<div id="wrongList"></div>
<button id="retryBtn" class="restart-btn" style="display:none" onclick="startRetry()">錯題重練</button>
<button class="restart-btn" onclick="restart()">重新測驗</button>
</div>

<script>
/* ========= 穩定音效核心 ========= */
let audioCtx;
function unlockAudio(){
 if(!audioCtx){
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
 }
}
function beep(freq=800,dur=0.1){
 if(!audioCtx) return;
 const o=audioCtx.createOscillator();
 const g=audioCtx.createGain();
 o.frequency.value=freq;
 o.connect(g); g.connect(audioCtx.destination);
 o.start();
 g.gain.setValueAtTime(0.3,audioCtx.currentTime);
 g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
 o.stop(audioCtx.currentTime+dur);
}
function speak(text){
 if(!('speechSynthesis'in window))return;
 speechSynthesis.cancel();
 const u=new SpeechSynthesisUtterance(text);
 u.lang="zh-TW";
 speechSynthesis.speak(u);
}

/* ========= 遊戲資料 ========= */
let list=[],wrongQuestions=[],retryList=[];
let idx=0,total=30,a=0,b=0,answer="";
let timer=null,sec=8;
let correct=0,wrongDetails=[],times=[];
let startTime=0,retryMode=false;

/* ========= 建立鍵盤 ========= */
function drawKeys(){
 const k=document.getElementById("keys");
 k.innerHTML="";
 for(let i=1;i<=9;i++) addKey(i);
 addKey(0);
 const del=document.createElement("button");
 del.textContent="⌫"; del.className="del";
 del.onclick=()=>{answer=answer.slice(0,-1);updateAnswer();}
 k.appendChild(del);

 const ok=document.createElement("button");
 ok.textContent="OK"; ok.className="ok";
 ok.onclick=submit;
 k.appendChild(ok);
}
function addKey(n){
 const b=document.createElement("button");
 b.textContent=n;
 b.onclick=()=>{answer+=n;updateAnswer();}
 document.getElementById("keys").appendChild(b);
}
function updateAnswer(){
 document.getElementById("answer").textContent=answer||"＿";
}

/* ========= 流程 ========= */
function startExam(){
 unlockAudio();
 document.getElementById("start").classList.add("hidden");
 document.getElementById("exam").classList.remove("hidden");
 list=[];
 for(let i=0;i<total;i++){
  let x=Math.ceil(Math.random()*9);
  let y=Math.ceil(Math.random()*9);
  list.push({a:x,b:y});
 }
 shuffle(list);
 resetVars();
 next();
}
function resetVars(){
 idx=0;correct=0;wrongDetails=[];wrongQuestions=[];
 times=[];retryMode=false;
}

function next(){
 if(idx>=total){finish();return;}
 const q=list[idx];
 a=q.a; b=q.b;
 idx++;
 answer="";
 document.getElementById("reveal").style.display="none";
 updateUI();
 startTime=Date.now();
 startTimer();
}

function updateUI(){
 document.getElementById("progress").textContent=`第 ${idx} / ${total} 題`;
 document.getElementById("question").textContent=`${a} × ${b} = ?`;
 updateAnswer();
}

function startTimer(){
 clearInterval(timer);
 sec=8;
 document.getElementById("timer").textContent=`剩餘 ${sec} 秒`;
 timer=setInterval(()=>{
  sec--;
  beep(600,0.05);
  document.getElementById("timer").textContent=`剩餘 ${sec} 秒`;
  if(sec<=0){
   clearInterval(timer);
   recordWrong();
  }
 },1000);
}

function submit(){
 if(answer==="")return;
 clearInterval(timer);
 const used=(Date.now()-startTime)/1000;
 if(Number(answer)===a*b){
  correct++;
  times.push(used);
  beep(1000,0.12); setTimeout(()=>beep(1200,0.12),150);
  next();
 }else{
  recordWrong();
 }
}

function recordWrong(){
 speak("答錯了");
 wrongDetails.push(`${a} × ${b} = ${a*b}`);
 wrongQuestions.push({a:a,b:b});
 document.getElementById("reveal").textContent=`正確答案：${a*b}`;
 document.getElementById("reveal").style.display="block";
 setTimeout(next,3200);
}

function finish(){
 clearInterval(timer);
 speak("恭喜你完成測驗");
 document.getElementById("exam").classList.add("hidden");
 document.getElementById("score").classList.remove("hidden");

 const avg=times.length?(times.reduce((a,b)=>a+b)/times.length).toFixed(1):0;
 document.getElementById("scoreText").textContent=`答對 ${correct} / ${total} 題`;
 document.getElementById("avgTime").textContent=`平均作答時間：${avg} 秒`;
 document.getElementById("wrongCount").textContent=`錯誤題數：${wrongDetails.length}`;

 let wl=document.getElementById("wrongList");
 wl.innerHTML=wrongDetails.map(x=>`<div>${x}</div>`).join("");

 if(wrongQuestions.length){
  const r=document.getElementById("retryBtn");
  r.style.display="block";
  r.textContent=`錯題重練（${wrongQuestions.length} 題）`;
 }
}

function startRetry(){
 retryMode=true;
 retryList=[...wrongQuestions];
 shuffle(retryList);
 list=retryList;
 total=list.length;
 resetVars();
 document.getElementById("score").classList.add("hidden");
 document.getElementById("exam").classList.remove("hidden");
 next();
}

function restart(){location.reload();}

function shuffle(arr){
 for(let i=arr.length-1;i>0;i--){
  const j=Math.floor(Math.random()*(i+1));
  [arr[i],arr[j]]=[arr[j],arr[i]];
 }
}

drawKeys();
</script>
</body>
</html>
